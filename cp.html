<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Control Panel</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
<script src="./js/functions.js" type="text/javascript"></script>
<script type="text/javascript">
	var newPos = null;
	function drag(ev) {
		ev.dataTransfer.setData("text", ev.target.id);
	}

	function drop(ev) {
		ev.preventDefault();
		var posId = parseInt(ev.dataTransfer.getData("text"));
		var data = document.getElementById(posId);
		var children = Array.from($('#listingJutsu').children());
		var targetPos = children.indexOf(ev.target.parentNode);
		newPos = targetPos;
		if(targetPos>children.indexOf(data))
		{
			
			ev.target.parentNode.after(data);
		}
		else
		{
			ev.target.parentNode.before(data);
		}
	}
	function dragEnd(ev)
	{
		var oldPos = parseInt(ev.target.id);
		moveJutsu(oldPos, newPos);
		populateJutsu();

		newPos = null;
	}
	function setJutsu(jutsu)
	{
		//jutsu = JSON.parse(jutsu);
		let jutsuID = jutsu["jutsu_id"];
		let jutsuName = jutsu["name"];
		let jutsuType = jutsu["jutsu_type"];
		let jutsuSeals;
		
		if (jutsuType == 'taijutsu')
		{
			jutsuSeals = jutsuID;
		}
		else
		{
			jutsuSeals = jutsu["hand_seals"];
		}
				
		$('#useType').val(jutsuType);
		$('#jutsuName').val(jutsuName);
		$('#sealNumbers').val(jutsuSeals);
	}
	function populateJutsu()
	{
		jutsuList = $.parseJSON(Cookies.get("jutsu"));
		$('#listingJutsu').empty();
		for(let i in jutsuList) { //Prints out visual table of jutsu's in array.
			var weaponID = (jutsuList[i].weaponID == undefined)? '' : jutsuList[i].weaponID;
			$('#listingJutsu').append("<tr draggable='true' ondragstart='drag(event)' ondragover='drop(event)' id=" + parseInt(i) + "><td>" + (parseInt(i) + 1) + "</td><td>" + jutsuList[i].jutsuName + "</td><td>" + jutsuList[i].jutsuType + "</td><td>" + jutsuList[i].jutsuSeals + "</td><td>" + weaponID + "</td><td>" + "<button data-id=" + parseInt(i) + " onClick='clearJutsu()'>Remove</button></td></tr>");
		};
	}
	function populateKeys()
	{
		keyMap = $.parseJSON(Cookies.get("customKeys"));
		$('#keysTable').empty();
		var keyElement = ``;
		for (const keySet in keyMap)
		{
			keyElement += `
				<tr>
					<th colspan="4">${keySet}</th>
				</tr>`;
			for (const key in keyMap[keySet])
			{
				if (key === "unmapped")
				{
					for (unmappedKey in keyMap[keySet][key])
					{
						keyElement += `
						<tr>
							<td style="width: 2rem;">${key}</td>
							<td style="width: 2rem;">${keyMap[keySet][key][unmappedKey]}</td>
							<td style="width: 2rem;">
								<input type="text" onKeyUp='remapKey(event);' data-set="${keySet}" data-key="${keyMap[keySet][key][unmappedKey]}" style="width: 3rem; height: 2rem;">
							</td>
						</tr>`;
					}
				}
				else
				{
					keyElement += `
						<tr>
							<td style="width: 2rem;">${key}</td>
							<td style="width: 2rem;">${keyMap[keySet][key]}</td>
							<td style="width: 2rem;">
								<input type="text" onKeyUp='remapKey(event);' data-set="${keySet}" data-key="${key}" style="width: 3rem; height: 2rem;">
							</td>
							<td style="width: 2rem;">
								<button onClick="clearBinding(event.target.dataset.set,event.target.dataset.key,event.target.dataset.action, true)" data-set="${keySet}" data-key="${key}" data-action="${keyMap[keySet][key]}">Clear Mapping</button>
							</td>
						</tr>`;
				}
				
			}
		}
		$('#keysTable').append(keyElement);
	}
	
</script>
<script type="module">
$(document).ready(async function() {
	const request = new Request('./sc_jutsu.json');
	const response = await fetch(request);
	const jutsuLibrary = await response.json();
	
	const request2 = new Request('./sc_weapons.json');
	const response2 = await fetch(request2);
	const weaponLibrary = await response2.json();
	
	for (let jutsu in jutsuLibrary)
	{
		let jutsuID = jutsuLibrary[jutsu]["jutsu_id"];
		let jutsuName = jutsuLibrary[jutsu]["name"];
		let jutsuType = jutsuLibrary[jutsu]["jutsu_type"];
		let jutsuRank = jutsuLibrary[jutsu]["rank"];
		let jutsuSeals;
		if (jutsuType == 'taijutsu')
		{
			jutsuSeals = jutsuID;
		}
		else
		{
			jutsuSeals = jutsuLibrary[jutsu]["hand_seals"];
		}
		$('#jutsuSearch').append("<tr>" + "<td>" + jutsuID + "</td>" + "<td>" + jutsuName + "</td>" + "<td>" + jutsuType + "</td><td>" + jutsuSeals + "</td><td>" + jutsuRank + "</td><td><button onclick='setJutsu(" + JSON.stringify(jutsuLibrary[jutsu]) + ");'>Add</button></td></tr>");
	}
	
	for (let weapon in weaponLibrary)
	{
		$('#weaponList').append("<tr>" +  "<td>" + weaponLibrary[weapon]['item_id'] + "</td><td>" + weaponLibrary[weapon]['name'] + "</td><td>" + weaponLibrary[weapon]['rank'] + "</td><td>" + weaponLibrary[weapon]['effect'] + "</td></tr>");
	}

	$('#addButton').click(function() { //When clicked calls addJutsu with input values.
		addJutsu($('#useType').val(),$('#jutsuName').val(),$('#sealNumbers').val(),$('#weaponID').val());
		location.reload();
		top.frames['toolBar'].location.reload();
	});
	$('#clearButton').click(function (e) {
		e.preventDefault();
		$('#useType').val('');
		$('#jutsuName').val('');
		$('#sealNumbers').val('');
		$('#weaponID').val('')
	});
	$('#clearAllButton').click(function() { //When clicked calls clearJutsu function emptying array.
		clearJutsu();
		location.reload();
		top.frames['toolBar'].location.reload();
	});
	$('#jutsuSearchType').change(function () {
		let jutsuSearch = $('#jutsuSearch tr');
		jutsuSearch.splice(0,1);
		
		jutsuSearch.children().parent().css("display", "table-row");
		if (this.value == '') return;
		jutsuSearch.filter((index) => {
			return (jutsuSearch[index].children[2].innerText == this.value.toLowerCase()) == false;
		}).css("display", "none");
	});
	
	$('#jutsuSearchName').keyup(function () {
		let searchText = this.value;
		let jutsuSearch = $('#jutsuSearch tr');
		jutsuSearch.splice(0,1);
		
		jutsuSearch.children().parent().css("display", "table-row");
		
		jutsuSearch.filter((index) => {
			return jutsuSearch[index].children[1].innerText.toLowerCase().startsWith(searchText.toLowerCase()) == false;
		}).css("display", "none");
	});
	
	$('[name=hideButton]').click(function () {
		let jutsuSearchDiv = $('#jutsuSearch').parent();
		let weaponListDiv = $('#weaponList').parent();
		let rebindingDiv = $("#keysTable");
		if ( this.value == 1)
		{
			
			if (jutsuSearchDiv.css('display') == 'block')
			{
				jutsuSearchDiv.hide();
			}
			else
			{
				jutsuSearchDiv.show();
				weaponListDiv.hide();
				rebindingDiv.hide();
			}
		}
		else if (this.value == 2)
		{
			
			if (weaponListDiv.css('display') == 'block')
			{
				weaponListDiv.hide();
			}
			else
			{
				weaponListDiv.show();
				jutsuSearchDiv.hide();
				rebindingDiv.hide();
			}
		}
		else if (this.value == 3)
		{
			if (rebindingDiv.css('display') == 'table')
			{
				rebindingDiv.hide();
			}
			else
			{
				rebindingDiv.show();
				weaponListDiv.hide();
				jutsuSearchDiv.hide();
			}
		}
		
	});

	if(Cookies.get("jutsu")) { // If cookie already exists pulls information into array.	
		populateJutsu();
	};
	if(Cookies.get("customKeys")) { // If cookie already exists pulls information into array.	
		populateKeys();
	};
	
});
</script>
<style>
table {
	width: 40%;
	user-select: none;
	-moz-user-select: none;
}
table, tbody, th {
	border: solid 1px;
}
td {
	border-bottom: solid 1px;
	border-right: solid 1px;
	text-align: center;
}
a {
	padding: 5px;
	text-decoration: none;
}
</style>
</head>

<body>
<a href="https://shinobichronicles.com/" target="mainFrame"> Return to SC</a>
<br/>
<span>You can re-arrage the jutsu order by dragging and dropping the rows.</span>
<br/>
<span> For bloodline jutsu seal is: 0 - Genin, 1 - Chuunin, 2 - Jonin</span> 
<br />
<span> For Taijutsu use Jutsu ID, check link in jutsu page. Use a jutsu id of 3 if you want a standard strike can be used in combination with a weapon id.</span>
<table ondragend="dragEnd(event)">
	<thead>
		<tr>
			<th>Key Number</th>
			<th>Jutsu Name</th>
			<th>Jutsu Type</th>
			<th>Jutsu Seals/ID</th>
			<th>Weapon ID</th>
		</tr>
	</thead>
	<tbody id="listingJutsu">
	</tbody>
</table>
<div>
	<form>
		<select id="useType">
			<option value="" selected>Select a style</option>
			<option value="ninjutsu">Ninjutsu</option>
			<option value="genjutsu">Genjutsu</option>
			<option value="taijutsu">Taijutsu</option>
			<option value="bloodline_jutsu">Bloodline</option>
		</select>
		<input type="text" value="" placeholder="name" id="jutsuName">
		<input type="text" value="" placeholder="Jutsu Seals or ID" id="sealNumbers">
		<input type="text" value="" placeholder="weapon id" id="weaponID">
		<button id="addButton">Submit</button>
		<button id="clearButton">Clear Input</button>
		<button id="clearAllButton">Clear All</button>
	</form>
<br/>
<button name="hideButton" value='1'>Toggle Jutsu List</button>
<button name="hideButton" value='2'>Toggle Weapon List</button>
<button name="hideButton" value='3'>Toggle Key Remapping</button>
<div style="display: none">
	<input type="text" value="" placeholder="name" id="jutsuSearchName">
	<select id="jutsuSearchType">
		<option value="" selected>Select a style</option>
		<option value="ninjutsu">Ninjutsu</option>
		<option value="genjutsu">Genjutsu</option>
		<option value="taijutsu">Taijutsu</option>
	</select>
	<table id="jutsuSearch">
		<tr>
			<th>Jutsu ID</th>
			<th>Jutsu Name</th>
			<th>Jutsu Type</th>
			<th>Jutsu Seals</th>
			<th>Jutsu Rank</th>
		</tr>
	</table>
</div>
	<div style="display: none">
	<table id="weaponList">
		<tr>
			<th>Weapon ID</th>
			<th>Weapon Name</th>
			<th>Weapon Rank</th>
			<th>Weapon Effect</th>
		</tr>
	</table>
	</div>
</div>
<table id="keysTable" style="width: auto;display: none;">
</table>
<button onClick="resetKeyMapping()">Restore default key bindings</button>
<br/>
<a href="https://shinobichronicles.com/" target="mainFrame"> Return to SC</a>
</div>
</body>
</html>
